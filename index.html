<html>
<head>
  <meta charset="utf-8">
  <script src="https://unpkg.com/vue"></script>
  <script src="https://unpkg.com/vuex"></script>
  <script src="trigger/trigger.js"></script>
  <style type="text/css">
    p {
      background-color: #fff7bc;
      border-radius: 2px;
      margin: 3px;
      width: auto;
      clear: both;
      float: left;
      font-size: 22;
    }
    input {
      border-radius: 10px;
      border: 1px solid #cccccc;
      margin: 2px;
      background-color: #ddb9ff;
    }  
    button.trigger {
      background-color: #7d7;
      border: none;
      border-radius: 10px;
      width: 40px;
      height: 40px;
      margin: 10px;
      color: white;
      font-size: 24;
    }
    button.trigger.active {
      background-color: #d22;
    }
    button.add {
      background-color: #d55;
      border: none;
      border-radius: 100px;
      width: 120px;
      height: 45px;
      margin: 10px;
      color: white;
      font-size: 20;      
    }
    .centered {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translateX(-50%) translateY(-50%);
    }
    .centered.permutator {
      margin-top: -250px;
    }
    button:focus {outline:0;}
  </style>
</head>
<body>
<div id="vueTemplates" style="display: none;">
  <div id='summatorTemplate'>
    <div>
      <button 
        class="add centered"
        v-bind:style='env.infoButton.styleObject'
        disabled
        >{{ sumValue }}</button>      
      <trigger 
        v-for="item in triggers"
        :key="item.id"
        :trigger="item"
        class="trigger"
        ></trigger>
      <button 
        class="add centered" 
        v-bind:style='env.sumButton.styleObject'
        v-on:click="startStopSum"
        >{{ env.sumButton.title }}</button>
      <button 
        class="add centered" 
        v-bind:style='env.moreRightButton.styleObject'
        v-on:click="makeTriggerRight"
        >{{ env.moreRightButton.title }}</button>        
      <button 
        class="add centered" 
        v-bind:style='env.resetButton.styleObject'
        v-on:click="reset"
        >{{ env.resetButton.title }}</button>
      <button 
        class="add centered" 
        v-bind:style="env.moreLeftButton.styleObject"
        v-on:click="makeTriggerLeft"
        >{{ env.moreLeftButton.title }}</button>        
    </div>
  </div>
  <div id="triggerTemplate">
    <button v-bind:class='{active: active}'></button>
  </div>
</div>

<div 
  id="work_area" 
  class='centered'
  >
  <summator ref='sum1' v-bind:env="env"></summator>
</div>

<div style="clear: both;"></div>
<div id="permutator" class='centered permutator'>
  <h1>Fill the fields with words</h1>
  <button class='add' @click="addFind">
  +1 field
  </button>
  <button class='add' @click="permutateClear">
    {{buttonLable}}
  </button>
  <div v-for="find in inputs">
    <input v-model="find.value">
  </div>
  <br>
  <div v-show='showResult'>
    <h3>Permutations</h3>
    <p>{{ text }}</p> 
  </div>
</div>

<script>

Vue.config.debug = true;
Vue.config.devtools = true;
Vue.config.productionTip = false;

Vue.component("trigger", {
  template: triggerTemplate.innerHTML,
  props: ["trigger"],
  data: function() {
    return this.trigger;
  },
});


const triggers = [Trigger.create(), Trigger.create(), Trigger.create()];
triggers.forEach((el) => el.id = Math.random());
const summator = Summator.create(triggers);

Vue.component("summator", {
  props: ['env'],
  template: summatorTemplate.innerHTML,
  data: function() {
    const summator = Summator.create(this.env.triggers);
    summator.triggers = summator.getTriggers();
    return summator;
  },
  watch: {
    triggers: function() {
      this.updateState();
    }
  },
  computed: {
    sumValue: function() {
      if (this.state.length <= 0) return 0;
      return parseInt(this.state.join(""), 2);
    }
  },
  created: function() {
    this.autoSumTimer = null;
    this.currentAutoSumAction = null;
  },
  methods: {
    createTriggerWithKey: function() {
      const newTrigger = Trigger.create();
      newTrigger.id = Math.random();
      return newTrigger;
    },
    makeTriggerLeft: function() {
      this.triggers.unshift(this.createTriggerWithKey());
    },
    makeTriggerRight: function() {
      this.triggers.push(this.createTriggerWithKey());
    },
    startAutoSum: function() {
      this.autoSumTimer = setInterval(() => this.add(), 500);
      this.env.sumButton.setStop();
    },
    stopAutoSum: function() {      
      this.env.sumButton.setStart();
    },    
    startStopSum: function() {
      clearInterval(this.autoSumTimer);
      if (this.state.length <= 0) {
        this.env.sumButton.showError();
        return;
      }
      if (this.currentAutoSumAction !== this.startAutoSum) {
        this.currentAutoSumAction = this.startAutoSum;
      } else {
        this.currentAutoSumAction = this.stopAutoSum;
      }
      this.currentAutoSumAction();
    },    
  }
});

const vue = new Vue({
  el: '#work_area',
  data: {
    env: {
      triggers: triggers,
      resetButton: {
        title: "RESET",
        styleObject: {
          "margin-top": "100px",
          "margin-left": "-150px",
        }
      },
      sumButton: {
        styleObject: {
          "margin-top": "100px",
          "background-color": "#4F4"
        },
        title: "AUTOSUM",
        setStop: function () {
          this.styleObject['background-color'] = "#dd0";
          this.title = "STOP";
        },
        setStart: function() {
          this.styleObject['background-color'] = "#4F4";
          this.title = "RESUME";
        },
        showError: function() {
          const oldWidth = this.styleObject['width'];
          const oldColor = this.styleObject['background-color'];
          const oldTitle = this.title;
          this.styleObject['width'] = "180px";
          this.styleObject['background-color'] = "#f33";
          this.title = "NO TRIGGERS";
          setTimeout(() => {
            this.styleObject['width'] = oldWidth;
            this.styleObject['background-color'] = oldColor;
            this.title = oldTitle;
          }, 1200);
        }
      },
      moreRightButton: {
        title: "ONE MORE RIGHT",
        styleObject: {
          "margin-top": "100px",
          "margin-left": "300px",
          "width": "350px"
        }
      },
      moreLeftButton: {
        title: "ONE MORE LEFT",
        styleObject: {
          "margin-top": "100px",
          "margin-left": "-400px",
          "width": "300px"
        }
      },
      infoButton: {
        styleObject: {
          "background-color": "#88d",
          "margin-top": "-100px",
          "width": "200px",
        }
      }
    }
  }
});


const permutator = new Vue({
  el: '#permutator',
  data: {
    inputs: [],
    permutations: [],
    buttonLable: 'Generate',
  },
  methods: {
    addFind: function () {
      this.inputs.push({ value: '01' });
    },
    getValues: function() {
      return this.inputs.map((el) => el.value).filter((el) => el.length > 0);
    },
    permutate: function() {
      const triggers = this.getValues().map((el) => Trigger.create(el) );
      const permutator = Permutator.create(triggers);
      permutator.promote();
      this.setPermutations(permutator.permutations.slice());
    },
    clearPermutations: function() {
      this.permutations = [];
    },
    setPermutations: function(newPermutations) {
      this.clearPermutations();
      this.permutations = newPermutations;
    },
    permutateClear: function() {
      if (this.currentAction !== this.permutate) {
        this.currentAction = this.permutate;
        this.buttonLable = 'Clear';
      } else {
        this.currentAction = this.clearPermutations;
        this.buttonLable = 'Generate';
      }
      this.currentAction();
    }
  },
  computed: {
    showResult: function() {
      return this.permutations.length > 0;
    },
    text: function() {
      return this.permutations.map((el) => el.join('')).join('  ');
    }
  },
  mounted: function() {
    this.inputs.push({value: '01'});
    this.currentAction = null;
  },
});

</script>

</body>
</html>